<!DOCTYPE html>
<html>

<head>

  <meta charset="UTF-8">

  <title>MarkTexting</title>

  <style>
    .mybutton {
      background-color: #4CAF50; /* Green */
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      cursor: pointer;
    }
  </style>

  <link rel="stylesheet" href="../../static/css/style.css" media="screen" type="text/css" />
  <script src='../../static/js/jquery.js'></script>
  <script src='../../static/js/cb_entitylist.js'></script>
</head>

<body>

  <span class='bckg'></span>
<header>
  <h1>
    Dashboard
  </h1>
  <nav id="mymenu">
    <ul>
      <li>
        <a target="_top" href="/index" data-title='Text'>Text</a>
      </li>
      <li>
        <a target="_top" href="/mgraph" data-title='Graph'>Graph</a>
      </li>
      <li>
        <a data-title='Entity' id="entity">Entity</a>
      </li>
        <ul id = "submene"></ul>
      <li>
        <a data-title='Import'>Import</a>
      </li>
      <li>
        <a data-title='Export'>Export</a>
      </li>
      <li>
        <a data-title='Invite'>Invite</a>
      </li>
    </ul>
  </nav>
</header>
<main>
  <div class='title'>
    <h2>Text</h2>
    <a href='/user/info' title='UserCenter' id='mytitle'></a>
  </div>
  <article class='larg'>
    <div>
      <h3>
        å¼•å¯¼
        <span class='entypo-down-open'>ğŸ‘‡</span>
      </h3>
      <p>ä½ å¯ä»¥åœ¨è¿™é‡Œç›´æ¥ç²˜è´´æ–‡æœ¬ï¼Œå¹¶è¿›è¡Œæ ‡è®°å·¥ä½œ</p>
      <p>å¯¹äºæ¯”è¾ƒé•¿çš„æ–‡æœ¬ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡<a href="#">Import</a>åŠŸèƒ½æ¥å¯¼å…¥æ–‡æœ¬æ ¼å¼æ–‡ä»¶</p>
      <!-- Importé¡µé¢å¼€å‘ä¸­ -->
    </div>
    <div>
      <span>
        <!-- ä¸Šä¼ æ–‡æœ¬çš„è¡¨å• -->
        <form action="" method="GET" style="float: left;" id="addText">
          <h3>
            åœ¨è¿™é‡Œç²˜è´´ä½ æƒ³è¦æ ‡è®°çš„æ–‡æœ¬:
          </h3>
          <textarea name="user_text" cols="40" rows="60"></textarea><br>
          <button type="button" class="mybutton" value="ä¸Šä¼ æ–‡æœ¬" id="submitText">ä¸Šä¼ æ–‡æœ¬</button> 
        </form>
      </span>
      <span>
        <!-- æ·»åŠ å®ä½“çš„è¡¨å• -->
        <form action="" method="GET" style="float: right;" id="addEntity">
          <h3>
            æ·»åŠ å®ä½“
          </h3>
          <table width="400">
            <tr>
              <td>
                <label for="entity_name" >å¡«å…¥ä½ è¦æ·»åŠ çš„å®ä½“åç§°</label>
              </td>
              <td>
                <input type="text" id="entity_name" name="entity_name" placeholder="å®ä½“åç§°"/>
              </td>
            </tr>
          </table>
          <button type="button" class="mybutton" value="æ·»åŠ å®ä½“" id="submitEntity" onclick="entitySubmit()">æ·»åŠ å®ä½“</button>
        </form>
          
        <!-- æ·»åŠ å…³ç³»çš„è¡¨å• -->
        <form action="" method="GET" style="float: right;" id="addRelation">
          <h3>
            æ·»åŠ å…³ç³»
          </h3>
          <table width="400">
            <tr>
              <td>
                <label for="relation_names">é€‰æ‹©ä½ è¦æ·»åŠ çš„å…³ç³»ç§ç±»</label>
              </td>
              <td>
                <select id="relation_name" name="relation_name">
                  <option value="ä»å±" id="1">ä»å±</option>
                  <option value="å¹¶åˆ—" id="2">å¹¶åˆ—</option>
                  <option value="è§£é‡Š" id="3">è§£é‡Š</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>
                é€‰æ‹©è¯¥å…³ç³»çš„ä¸¤ä¸ªå®ä½“åç§°
              </td>
              <td>
                <select id="source_id" name="source_name"></select>
              </td>
            </tr>
            <tr>
              <td></td>
              <td>
                <select id="destination_id" name="destination_name"></select>
              </td>
            </tr>
          </table>
          <button type="button" class="mybutton" value="æ·»åŠ å…³ç³»" id="submitRelation" onclick="sendRelation()">æ·»åŠ å…³ç³»</button>
        </form>
      </span>
    </div>

    
    <div style="text-align:center;clear:both;"></div>

    <!-- <div id="myDiv"><h2>ä½¿ç”¨ AJAX ä¿®æ”¹è¯¥æ–‡æœ¬å†…å®¹</h2></div>
    <button type="button" onclick="loadXMLDoc()">ä¿®æ”¹å†…å®¹</button> -->
  </article>
</main>

  <script src="../../static/js/index.js"></script>

</body>
<script type="text/javascript" src="../../static/js/jquery.min.js"></script>
<script type="text/javascript">
  window.onload = function() {
    getEntities();
    getUserInfo();
  }
  
  // p.s.éœ€è¦ç”¨æˆ·ä¸Šä¼ æ–‡æ¡£çš„æ¥å£...
  //function sendText() {}
  function entitySubmit() {
    sendEntity();
    location.reload();
    //getEntities();
  }

  function sendEntity() {
      var name = $("#entity_name").val();
      $.ajax({
          type:"POST",
          url:"/api/project/entities",
          contentType: "application/json",
          async:false,
          dataType:"json",
          data:JSON.stringify({
              "action":"add_entity",
              "data":{
                  "name":name
              }
          }),
          success:function (data) {
            if (data.ret != 0) {
              alert("æç¤ºï¼š" + data.msg);
            }
        },
      })
  }

  function getEntities() {
      //æ›´æ–°æ·»åŠ å…³ç³»çš„ä¸¤ä¸ªå®ä½“ä¸‹æ‹‰æ 
      $.ajax({
        type:"GET",
        url:"/api/project/entities?action=list_entity",
        async:false,
        success: function (data) {
          var srcEntity = document.getElementById("source_id");
          var dstEntity = document.getElementById("destination_id");
          for (var i = 0; i <= data.retlist.length - 1; i ++) {
            var opt1 = new Option(data.retlist[i].name, data.retlist[i].id);
            var opt2 = new Option(data.retlist[i].name, data.retlist[i].id);
            if (!isItemExist(srcEntity, opt1)) {
              srcEntity.add(opt1);
            }
            if (!isItemExist(dstEntity, opt2)) {
              dstEntity.add(opt2);
            }
          }
        },
        //ç”±äºè¯¥å‡½æ•°æ˜¯åœ¨é¡µé¢åŠ è½½æ—¶å°±è¢«è°ƒç”¨ï¼Œæ‰€ä»¥ç”¨æ¥åˆ¤æ–­æ˜¯å¦ç™»å½•ï¼Œå¦‚æœæœªç™»å½•ï¼ŒæŠŠç”¨æˆ·é€èµ°
        error: function(data) {
          var json = JSON.parse(data.responseText);
          alert(json.msg);
          if (json.ret == 302) {
            window.location.href = json.redirect;
          }
        }
      })
  }

  function isItemExist(objSelect,objItemValue) {
Â Â Â Â var isExit = false;
Â Â Â Â for(var i=0;i<objSelect.length;i++)
Â Â Â Â {
Â Â Â Â Â Â if ((objSelect.options[i].text == objItemValue.text) && (objSelect.options[i].value == objItemValue.value))
Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â isExit = true;
Â Â Â Â Â Â Â Â Â Â break;
Â Â Â Â Â Â }
Â Â Â Â }Â Â Â Â  
Â Â Â Â return isExit;
  }
  function sendRelation() {
    var source_id = $("#source_id").val();
    var destination_id = $("#destination_id").val();
    var relation_name = $("#relation_name").val();
    // ä¸Šè¿°å°†æ·»åŠ å…³ç³»çš„formä¿¡æ¯è½¬åŒ–ä¸ºjsonå­—ç¬¦ä¸²jsonRelation

    // htmlé¡µé¢å†…è°ƒè¯•ç”¨
    // $("#show2").html(JSON.stringify(jsonRelation));
    $.ajax({
        type:"POST",
        url:"/api/project/relations",
        contentType: "application/json",
        dataType:"json",
        async:false,
        data:JSON.stringify({
            "action":"add_relation",
            "data":{
                "name":relation_name,
                "source_id":source_id,
                "target_id":destination_id
            }
        }),
        success:function (data) {
          console.log(data);
          if (data.ret != 0) {
              alert("æç¤ºï¼š" + data.msg);
          }
        },
        error:function (data) {
          console.log(data);
        }
    })
    location.reload();
  }

  function getUserInfo() {
    $.ajax({
      type:"GET",
      url:"/user/other",
      contentType: "application/json",
      async:false,
      success: function (data) {
        if (data.ret == 0) {
          console.log(data);
          $('#mytitle').html(data.user_name);
        } else {
          console.log(data);
        }
      },
    })
  }
</script>
</html>
